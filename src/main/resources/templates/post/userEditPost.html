<!DOCTYPE html>
<html lang="zh-Hant-TW" xmlns:th="http://www.thymeleaf.org/">

<head>
  <meta th:replace="~{commons/userHead}">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <title>編輯貼文</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;


      color: #333;
    }

    h1 {
      text-align: center;
      color: #5F46E8;
    }

    form {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: 0 auto;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .button {
      background-color: #5F46E8;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
    }

    .listbtn {
      width: 5%;
    }

    button:hover {
      background-color: #5F46E8;
    }

    #updateResult {
      margin-top: 20px;
      text-align: center;
      font-weight: bold;
      color: #d9534f;
      /* Red color for errors */
    }

    .success {
      color: #5F46E8;
      /* Green color for success */
    }
  </style>

</head>

<body>
  <div th:replace="~{commons/userHeader}"></div>
  <h1>Edit Post</h1>
  <button class="button listbtn postList ">上一頁</button></td>
  <form id="editPostForm">
    <label for="postTitle">標題:</label>
    <input type="text" id="postTitle" name="postTitle" required>

    <label for="postContent">內容:</label>
    <textarea id="postContent" name="postContent" required rows="10"></textarea>
    <div class="mb-3">
    <label for="fullPostCategory">分類:</label>
    <select id="fullPostCategory" name="categoryID" class="border p-2 mb-4 w-full"></select>

    <label for="fullPostTag">標籤:</label>
    <select id="fullPostTag" name="tagID" class="border p-2 mb-4 w-full"></select>

    <label for="formFileMultiple" class="form-label">新增圖片:</label>
    <input class="form-control" type="file" name="image" accept="image/*" id="formFileMultiple" multiple>
    </div>
    <div id="imageList" style="margin-top: 20px;">
      <h4>圖片清單</h4>
      <div id="imagePreview"></div>
    </div>

    <button class="button" type="button" onclick="updatePost()">Save Changes</button>
  </form>

  <div id="updateResult"></div>

  <script>

    // 動態填充分類和標籤選項
    axios.get('/TickitEasy/admin/api/post/categories')
      .then(response => {
        const categories = response.data;
        categories.forEach(category => {
          $('#fullPostCategory').append(new Option(category.categoryName, category.categoryId));

        });
      });

    axios.get('/TickitEasy/admin/api/post/tags')
      .then(response => {
        const tags = response.data;
        tags.forEach(tag => {
          $('#fullPostTag').append(new Option(tag.tagName, tag.tagId));

        });
      });
    $('.postList').on('click', function () {

      window.location.href = `/TickitEasy/user/post/PostList`;
    });

 //上傳圖片預覽
    const imageInput = document.getElementById('formFileMultiple');
    const imagePreview = document.getElementById('imagePreview');
    const uploadedImages = []; // 用來存儲已上傳的圖片資訊

    imageInput.addEventListener('change', function () {
      // imagePreview.innerHTML = '';  // 清空上次的圖片預覽
      const files = imageInput.files;

      //加入多張圖片並驗證檔案是否重複
      for (let i = 0; i < files.length; i++) {
        if (!uploadedImages.some(img => img.name === files[i].name)) {
          const fileName = files[i].name;

          // // 將檔案名稱加入陣列（可選）
          // uploadedImages.push(fileName);
          // 將檔案資訊加入陣列
          uploadedImages.push(files[i]);


          // 創建顯示檔名和圖片的容器
          const imageItem = document.createElement('div');
          imageItem.classList.add('image-item');

          // 創建預覽圖像元素
          const imgElement = document.createElement('img');
          imgElement.src = URL.createObjectURL(files[i]);

          imgElement.style.width = '100px';
          imgElement.style.marginRight = '10px';


          // 創建顯示檔名的元素
          const fileNameElement = document.createElement('span');
          fileNameElement.textContent = fileName;
          // const fileNameElement = document.createElement('div');
          // fileNameElement.textContent = files[i].name; // 取得檔案名稱
          // fileNameElement.style.textAlign = 'center'; // 讓檔名置中

          // 創建刪除按鈕
          const deleteBtn = document.createElement('span');
          deleteBtn.innerHTML = '<i class="fa-solid fa-x"></i>';
          deleteBtn.classList.add('delete-btn');
          deleteBtn.dataset.index = i; // 儲存索引以便後續查找
          deleteBtn.addEventListener('click', function () {
            // 從預覽中刪除該項
            const index = parseInt(deleteBtn.dataset.index); // 獲取索引
            imagePreview.removeChild(imageItem);

            // 從 uploadedImages 陣列中移除該檔案
            // const index = uploadedImages.indexOf(files[i]);
            if (index > -1) {
              uploadedImages.splice(index, 1);
         
            }
          });

          // // 創建容器來包裝圖片和檔名
          // const container = document.createElement('div');
          // container.style.display = 'inline-block'; // 使圖片和檔名在同一行
          // container.style.marginRight = '20px'; // 調整容器之間的間距

          // 將圖片和檔名添加到容器
          imageItem.appendChild(imgElement);
          imageItem.appendChild(fileNameElement);
          imageItem.appendChild(deleteBtn);

          // 將容器添加到預覽區域
          imagePreview.appendChild(imageItem);
          // // 將圖片和檔名加入容器，然後將容器加入預覽區域
          // container.appendChild(imgElement);
          // container.appendChild(fileNameElement);
          // imagePreview.appendChild(container);

          // 將圖片資訊保存到uploadedImages陣列
          // uploadedImages.push(files[i]);
        }
      }
    });

    // const urlParams = new URLSearchParams(window.location.search);
    // const postID = urlParams.get('postID');  // 從 URL 中獲取 postID
    const postID = window.location.pathname.split("/")[4];

    console.log("Post ID:", postID); // 調試用

    // 當頁面加載時，取得要編輯的貼文內容並填充到表單
    async function fetchPost() {
      try {
        const response = await axios.get(`/TickitEasy/admin/api/post/GET/${postID}`);

        const post = response.data;
        document.getElementById('postTitle').value = post.postTitle;
        document.getElementById('postContent').value = post.postContent;
        document.getElementById('fullPostCategory').value = post.postCategory.categoryID;
        document.getElementById('fullPostTag').value = post.postTag.tagID;
        //圖片清單+刪除按鈕
        const postImagesHTML = (post.images || []).map(image => `
                    <div class="image-container" style="position: relative; display: inline-block; margin-bottom: 10px;">
                    <img src="/TickitEasy/images/post/${image.imagePath.split('/').pop()}" alt="Post Image" style="width: 60%; height: auto;" />
                    <i class="fa-solid fa-x" style="position: absolute; top: 0; right: 0; cursor: pointer;" onclick="deleteImage(${image.imageID})"></i>
                  </div>`).join('');
        document.getElementById('imagePreview').innerHTML = `
                         <div class="post-images">${postImagesHTML}</div>
                    `;
      } catch (error) {
        if (error.response) {
          document.getElementById("updateResult").innerText = `Failed to load post: ${error.response.status}`;
        } else {
          document.getElementById("updateResult").innerText = `Error: ${error.message}`;
        }
      }
    }

    // 更新貼文
    async function updatePost() {
      const title = document.getElementById("postTitle").value;
      const content = document.getElementById("postContent").value;
      const category = document.getElementById("categoryID").value;
      const tag = document.getElementById("tagID").value;

      const postData = {
        postTitle: title,
        postContent: content,
        categoryID:category,
        tagID:tag

      };

      try {
        const response = await axios.put(`/TickitEasy/admin/api/post/PUT/${postID}`, postData, {
          headers: {
            "Content-Type": "application/json"
          }
        });

        document.getElementById("updateResult").innerText = "Post updated successfully!";
        document.getElementById("updateResult").className = "success";

        setTimeout(() => {
          window.location.href = `/TickitEasy/user/post/${postID}`;
        }, 1000); // 1秒後跳轉

      } catch (error) {
        if (error.response) {
          document.getElementById("updateResult").innerText = `Failed to update post: ${error.response.status}`;
        } else {
          document.getElementById("updateResult").innerText = `Error: ${error.message}`;
        }
      }
    }

    // 刪除圖片
    async function deleteImage(imageID) {
      try {
        const response = await axios.delete(`/TickitEasy/admin/api/post/images/delete/${imageID}`);

        if (response.status === 200) {
          document.getElementById("updateResult").innerText = "Image deleted successfully!";
          document.getElementById("updateResult").className = "success";
          // 重新載入圖片列表
          fetchPost();
        } else {
          document.getElementById("updateResult").innerText = `Failed to delete image: ${response.status}`;
        }
      } catch (error) {
        document.getElementById("updateResult").innerText = `Error: ${error.message}`;
      }
    }

    // 初始化載入
    fetchPost();
    $('.postList').on('click', function () {

      window.location.href = `/TickitEasy/user/post/PostList`;
    });
  </script>
  <div th:replace="~{commons/userFooter}"></div>
</body>

</html>