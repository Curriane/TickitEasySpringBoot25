<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.css"
    />
    <link rel="stylesheet" href="/TickitEasy/cwdfunding/css/card.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.css"
    />
    <title>募資專案</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.js"></script>
    <script>
      $(document).ready(function () {
        let currentPage = 1;
        let output = document.getElementById("outputBlock");
        let spinnerBlock = document.getElementById("spinnerBlock");
        loadThatPage(1);

        // 拿到 pageNumber 輸出 json 資料
        function loadThatPage(pageNum) {
          currentPage = pageNum;
          // spinner();
          axios
            .get("http://localhost:8080/TickitEasy/member/api/fundproject", {
              params: {
                pageNumber: pageNum,
              },
            })
            .then((res) => {
              console.log(res.data);
              htmlMaker(res.data);
            });
        }

        function spinner() {
          output.innerHTML = "";
          spinnerBlock.innerHTML = "";
          spinnerBlock.innerHTML = `<div class="d-flex m-5 justify-content-center">
             <div class="spinner-border" role="status">
               <span class="visually-hidden">Loading...</span>
             </div>
           </div>`;
        }

        function htmlMaker(pageData) {
          let output = document.getElementById("outputBlock");
          let pageBtnBlock = document.getElementById("pageBtnBlock");

          output.innerHTML = "";
          spinnerBlock.innerHTML = "";
          pageBtnBlock.innerHTML = "";

          pageData.content.forEach((el) => {
            // 計算由json格式而來的變數： 1.目前進度 2.剩餘天數
            let currentAmount = el.currentAmount;
            let targetAmount = el.targetAmount;
            let startTime = el.startDate;
            let endTime = el.endDate;

            let strartDate = new Date(startTime.replace(" ", "T"));
            let endDate = new Date(endTime.replace(" ", "T"));

            let nowProgress =
              (parseInt(currentAmount) / parseInt(targetAmount)) * 100;
            let diffMilliseconds = endDate - strartDate;
            let diffDays = Math.floor(diffMilliseconds / (1000 * 60 * 60 * 24));

            output.innerHTML += `        <div class="col d-flex justify-content-center mb-3">
          <a href="#" class="card h-100 custom-card">
            <img src="/TickitEasy${el.image}" class="card-img-top" alt="..." />
            <div class="card-body">
              <div class="card-title fw-semibold custom-title-text">${el.title}</div>
            </div>
            <div class="card-footer bg-transparent border-0 mt-2">
              <div class="row">
                <div class="col-12">
                  <div
                    class="progress mb-2"
                    role="progressbar"
                    aria-label="Success example"
                    aria-valuenow="${nowProgress}"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  >
                    <div class="progress-bar" style="width: ${nowProgress}%"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-between">
                <div class="text-start">
                  <small class="fw-semibold custom-small-text"
                    >NT$ ${el.currentAmount}</small
                  >
                </div>
                <div class="text-end">
                  <small class="text-end custom-small-text"
                    ><i class="fa-solid fa-user" style="color: #797a7c"></i
                  ></small>
                  <small class="me-2 fw-semibold custom-small-text"
                    >8,628 人
                  </small>
                  <small class="text-end custom-small-text">
                    <i
                      class="fa-solid fa-hourglass-start"
                      style="color: #797a7c"
                    ></i
                  ></small>
                  <small class="fw-semibold  custom-small-text">${diffDays} 天 </small>
                </div>
              </div>
            </div>
          </a>
        </div>`;
          });
          // 印頁數 (pageData.totalPages)
          pageBtnBlock.innerHTML += `
                    <li class="page-item ${
                      currentPage === 1 ? "disabled" : ""
                    }">
                        <a class="page-link" href="#" id="prevPage">&laquo;</a>
                    </li>`;
          for (let i = 1; i <= pageData.totalPages; i++) {
            pageBtnBlock.innerHTML += `<li class="page-item pageBtn" data-pagebtn="${i}"><a class="page-link">${i}</a></li>`;
          }
          pageBtnBlock.innerHTML += `
                    <li class="page-item ${
                      currentPage === pageData.totalPages ? "disabled" : ""
                    }">
                        <a class="page-link" href="#" id="nextPage">&raquo;</a>
                    </li>`;

          let pageBtns = document.getElementsByClassName("pageBtn");

          for (let i = 0; i < pageBtns.length; i++) {
            pageBtns[i].addEventListener("click", function (e) {
              e.preventDefault();
              let pageID = this.getAttribute("data-pagebtn");
              console.log("pageID: " + pageID);
              loadThatPage(pageID);
            });
          }
        }
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="text-center mb-4">
        <h1>Bootstrap card tiled layout</h1>
      </div>
      <div
        id="outputBlock"
        class="row row-cols-1 row-cols-md-3 g-4 ms-5 me-5"
      ></div>
      <div id="spinnerBlock"></div>
      <div id="pageBlock" class="d-flex justify-content-center mt-3">
        <nav aria-label="...">
          <ul class="pagination" id="pageBtnBlock"></ul>
        </nav>
      </div>
    </div>
  </body>
</html>
